import numpy as np
from osgeo import gdal,ogr,osr

import json

geojson_list = [{'type': 'Polygon', 'coordinates': [[[116.47371356996614, 40.604658447166294], [116.47371568980334, 40.60438819283492], [116.47336110483863, 40.604386576623504], [116.47336534728291, 40.60384606795307], [116.47301076520309, 40.60384445068386], [116.47301288781009, 40.603574196344816], [116.47265830718706, 40.603572578002485], [116.4726604311933, 40.60330232366601], [116.47301501038835, 40.60330394199299], [116.47301713293783, 40.60303368762839], [116.47337171073364, 40.6030353048516], [116.473380194932, 40.60195428720406], [116.4740893391864, 40.60195751826266], [116.47408722103576, 40.60222777272433], [116.47479636826084, 40.60223099945999], [116.47480059882182, 40.60169049046263], [116.47515516962159, 40.60169210216729], [116.47515728343114, 40.601421847634164], [116.4772847002637, 40.60143149491481], [116.47728259502135, 40.60170174953943], [116.47763716602131, 40.60170335362548], [116.47763506217831, 40.60197360825254], [116.47798963463471, 40.60197521126541], [116.47798753219111, 40.602245465894896], [116.47692381062377, 40.60224065354548], [116.47692170386786, 40.60251090811654], [116.47656712864126, 40.60250930180804], [116.4765692368251, 40.602239047252205], [116.47621466305502, 40.60223743987056], [116.47619778535994, 40.604399475837525], [116.47584320019448, 40.60439786724544], [116.47584108892579, 40.60466812166856], [116.47371356996614, 40.604658447166294]]]}, {'type': 'Polygon', 'coordinates': [[[116.47371356996614, 40.604658447166294], [116.47371568980334, 40.60438819283492], [116.47336110483863, 40.604386576623504], [116.47336534728291, 40.60384606795307], [116.47301076520309, 40.60384445068386], [116.47301288781009, 40.603574196344816], [116.47265830718706, 40.603572578002485], [116.4726604311933, 40.60330232366601], [116.47301501038835, 40.60330394199299], [116.47301713293783, 40.60303368762839], [116.47337171073364, 40.6030353048516], [116.473380194932, 40.60195428720406], [116.4740893391864, 40.60195751826266], [116.47408722103576, 40.60222777272433], [116.47479636826084, 40.60223099945999], [116.47480059882182, 40.60169049046263], [116.47515516962159, 40.60169210216729], [116.47515728343114, 40.601421847634164], [116.4772847002637, 40.60143149491481], [116.47728259502135, 40.60170174953943], [116.47763716602131, 40.60170335362548], [116.47763506217831, 40.60197360825254], [116.47798963463471, 40.60197521126541], [116.47798753219111, 40.602245465894896], [116.47692381062377, 40.60224065354548], [116.47692170386786, 40.60251090811654], [116.47656712864126, 40.60250930180804], [116.4765692368251, 40.602239047252205], [116.47621466305502, 40.60223743987056], [116.47619778535994, 40.604399475837525], [116.47584320019448, 40.60439786724544], [116.47584108892579, 40.60466812166856], [116.47371356996614, 40.604658447166294]]]}, {'type': 'Polygon', 'coordinates': [[[116.5029240296422, 40.63451683397704], [116.5029260339342, 40.634246579814075], [116.50257128944072, 40.634245052354565], [116.50258332320317, 40.63262352719556], [116.502228587318, 40.63262199873339], [116.50223862185584, 40.63127072748883], [116.50188389314825, 40.63126919800959], [116.50188590140418, 40.63099894373686], [116.50153117415384, 40.63099741318261], [116.50153720304822, 40.63018665033139], [116.50189192600862, 40.630188180842104], [116.50188991783439, 40.63045843515314], [116.50401826474778, 40.63046759542525], [116.50437298932836, 40.630469118324065], [116.50437099113674, 40.63073937272362], [116.50472571717441, 40.630740894547365], [116.50508044323914, 40.630742415281624], [116.50507844788042, 40.63101266969725], [116.50578790295104, 40.63101570792609], [116.50578989544977, 40.630745453481644], [116.50614462159562, 40.6307469709474], [116.50614661263732, 40.630476716475805], [116.50792023662127, 40.63048428739029], [116.50792222048615, 40.63021403283414], [116.50756749706545, 40.63021252084456], [116.5075694823334, 40.62994226628997], [116.50827892634183, 40.629945289151], [116.508280908723, 40.629675034554985], [116.5086356293376, 40.629676544336974], [116.5086296864033, 40.63048730812966], [116.5089844113346, 40.6304888168651], [116.50898243173276, 40.63075907145144], [116.50933715812091, 40.63076057911169], [116.50933320169672, 40.63130108827465], [116.50897847244856, 40.63129958058581], [116.50897649276618, 40.631569835133824], [116.50862176211479, 40.63156832634115], [116.50861779980936, 40.6321088353703], [116.50897253332089, 40.63211034419159], [116.50896857376821, 40.63265085319827], [116.50932331016679, 40.632652360958595], [116.50932133178034, 40.632922615457076], [116.5096760696359, 40.632924122142114], [116.50967409265274, 40.63319437664211], [116.5100288319653, 40.63319588225184], [116.5103835713046, 40.63319738677196], [116.51038159715503, 40.63346764128774], [116.5086078935756, 40.63346010771972], [116.50860987487609, 40.63318985327538], [116.50825513567091, 40.633188343307275], [116.50754565734123, 40.63318532010229], [116.50754764290534, 40.63291506568815], [116.50719290521101, 40.63291355246562], [116.50719489217833, 40.63264329805307], [116.50648541973085, 40.632640268367965], [116.50648342990327, 40.63291052275179], [116.50612869228985, 40.63290900626051], [116.5061247096934, 40.6334495149611], [116.50576996924664, 40.63344799735146], [116.50576797647773, 40.633718251668206], [116.50541323462782, 40.63371673295457], [116.50541124040164, 40.63398698724414], [116.50505649714856, 40.63398546742647], [116.50506447961172, 40.63290445024916], [116.50470974210643, 40.63290292939955], [116.50400026717712, 40.63289988443157], [116.50400226701565, 40.63262963014863], [116.50364753102181, 40.63262810604471], [116.50364352845733, 40.63316861456896], [116.50328878963033, 40.63316708934656], [116.50327877559307, 40.63451836036139], [116.5029240296422, 40.63451683397704]]]}, {'type': 'Polygon', 'coordinates': [[[116.5029240296422, 40.63451683397704], [116.5029260339342, 40.634246579814075], [116.50257128944072, 40.634245052354565], [116.50258332320317, 40.63262352719556], [116.502228587318, 40.63262199873339], [116.50223862185584, 40.63127072748883], [116.50188389314825, 40.63126919800959], [116.50188590140418, 40.63099894373686], [116.50153117415384, 40.63099741318261], [116.50153720304822, 40.63018665033139], [116.50189192600862, 40.630188180842104], [116.50188991783439, 40.63045843515314], [116.50401826474778, 40.63046759542525], [116.50437298932836, 40.630469118324065], [116.50437099113674, 40.63073937272362], [116.50472571717441, 40.630740894547365], [116.50508044323914, 40.630742415281624], [116.50507844788042, 40.63101266969725], [116.50578790295104, 40.63101570792609], [116.50578989544977, 40.630745453481644], [116.50614462159562, 40.6307469709474], [116.50614661263732, 40.630476716475805], [116.50792023662127, 40.63048428739029], [116.50792222048615, 40.63021403283414], [116.50756749706545, 40.63021252084456], [116.5075694823334, 40.62994226628997], [116.50827892634183, 40.629945289151], [116.508280908723, 40.629675034554985], [116.5086356293376, 40.629676544336974], [116.5086296864033, 40.63048730812966], [116.5089844113346, 40.6304888168651], [116.50898243173276, 40.63075907145144], [116.50933715812091, 40.63076057911169], [116.50933320169672, 40.63130108827465], [116.50897847244856, 40.63129958058581], [116.50897649276618, 40.631569835133824], [116.50862176211479, 40.63156832634115], [116.50861779980936, 40.6321088353703], [116.50897253332089, 40.63211034419159], [116.50896857376821, 40.63265085319827], [116.50932331016679, 40.632652360958595], [116.50932133178034, 40.632922615457076], [116.5096760696359, 40.632924122142114], [116.50967409265274, 40.63319437664211], [116.5100288319653, 40.63319588225184], [116.5103835713046, 40.63319738677196], [116.51038159715503, 40.63346764128774], [116.5086078935756, 40.63346010771972], [116.50860987487609, 40.63318985327538], [116.50825513567091, 40.633188343307275], [116.50754565734123, 40.63318532010229], [116.50754764290534, 40.63291506568815], [116.50719290521101, 40.63291355246562], [116.50719489217833, 40.63264329805307], [116.50648541973085, 40.632640268367965], [116.50648342990327, 40.63291052275179], [116.50612869228985, 40.63290900626051], [116.5061247096934, 40.6334495149611], [116.50576996924664, 40.63344799735146], [116.50576797647773, 40.633718251668206], [116.50541323462782, 40.63371673295457], [116.50541124040164, 40.63398698724414], [116.50505649714856, 40.63398546742647], [116.50506447961172, 40.63290445024916], [116.50470974210643, 40.63290292939955], [116.50400026717712, 40.63289988443157], [116.50400226701565, 40.63262963014863], [116.50364753102181, 40.63262810604471], [116.50364352845733, 40.63316861456896], [116.50328878963033, 40.63316708934656], [116.50327877559307, 40.63451836036139], [116.5029240296422, 40.63451683397704]]]}, {'type': 'Polygon', 'coordinates': [[[116.48581746363081, 40.644711907978845], [116.48581953764285, 40.6444416550082], [116.48546474011444, 40.64444007467736], [116.48547926742754, 40.64254830363005], [116.48583405493974, 40.64254988385601], [116.48584857085856, 40.640658112077794], [116.48549379336166, 40.640656531956715], [116.48549171831263, 40.64092678509124], [116.48513693941314, 40.64092520386529], [116.48513486290527, 40.64119545697204], [116.4844253023294, 40.641192291220484], [116.4844273816987, 40.64092203814376], [116.48407260288376, 40.64092045364817], [116.48407676439913, 40.6403799474864], [116.4844315403527, 40.640381531951945], [116.48442946103978, 40.64065178505424], [116.48513901589287, 40.64065495074575], [116.48514109234443, 40.64038469761344], [116.48620542054316, 40.64038943793177], [116.48620749267458, 40.64011918474174], [116.48727181683422, 40.64012391520649], [116.48727595242903, 40.639583408698414], [116.48763072434375, 40.63958498331043], [116.4876327906685, 40.6393147300223], [116.48798756118063, 40.63931630352958], [116.48798962604675, 40.63904605021374], [116.4894087026529, 40.63905233328511], [116.4894128208567, 40.638511826495986], [116.49047712002124, 40.63851652726736], [116.490483284243, 40.637705766854175], [116.49190233301964, 40.637712019114474], [116.49190028402886, 40.63798227265759], [116.49225504772303, 40.63798383301306], [116.492253000135, 40.638254086558206], [116.49189823501032, 40.63825252618794], [116.491896185964, 40.63852277970551], [116.49154141943657, 40.63852121823066], [116.49153936893191, 40.63879147172066], [116.49189413688987, 40.63879303321031], [116.49224890487561, 40.63879459361017], [116.4922304748338, 40.641226874711705], [116.49294003664019, 40.64122999250806], [116.49294208167227, 40.64095973907388], [116.49329686118635, 40.640961296322445], [116.49329277395596, 40.64150180320758], [116.4929379915804, 40.64150024592949], [116.49293185623462, 40.64231100611709], [116.49257706959447, 40.642309447704754], [116.49257092970653, 40.64312020773308], [116.49292572063924, 40.643121766189736], [116.49292367538527, 40.64339201952175], [116.4922140906859, 40.643388901488905], [116.49221613880161, 40.64311864818645], [116.49186134792444, 40.643117087549875], [116.49185929837789, 40.64338734083753], [116.49150450609764, 40.64338577909616], [116.4915004040593, 40.643926285603506], [116.49114560894506, 40.64392472274253], [116.49114150393356, 40.64446522916916], [116.48972231230762, 40.644458966706566], [116.48972437055112, 40.64418871355901], [116.48936957414531, 40.644187145233204], [116.4893716337918, 40.64391689208774], [116.48972642876667, 40.643918460398694], [116.48972848695435, 40.6436482072256], [116.49008328052619, 40.643649774431694], [116.49008533725504, 40.64337952123096], [116.4904401294239, 40.64338108733223], [116.49044218469399, 40.64311083410387], [116.49008739395599, 40.64310926801747], [116.49008945062906, 40.642839014791186], [116.48796071537268, 40.642829595472776], [116.48794832340339, 40.64445111410297], [116.4875935257065, 40.64444954031221], [116.48759145884928, 40.64471979335762], [116.48581746363081, 40.644711907978845]], [[116.48903744808194, 40.64121279067846], [116.49116613233254, 40.641222189843], [116.49117023667607, 40.6406816831098], [116.49081545875936, 40.64068011933676], [116.49081751232006, 40.64040986596582], [116.49117228880607, 40.64041142972403], [116.49117434090824, 40.6401411763255], [116.49011001582576, 40.640136481825785], [116.49010795943158, 40.6404067351798], [116.48939840665467, 40.640403600034354], [116.48939634737125, 40.64067385334588], [116.489041569594, 40.64067228412348], [116.48903744808194, 40.64121279067846]]]}]
class_id_values=[1,0,1,1,1]

subtask_border = {"type": "Polygon", "coordinates": [[[116.43983166844481, 40.670443076100625], [116.53117959144176, 40.670443076100625], [116.53117959144176, 40.60166282346532], [116.43983166844481, 40.60166282346532], [116.43983166844481, 40.670443076100625]]]}

pts = np.array(subtask_border['coordinates'][0])
minx = pts[:, 0].min()
maxx = pts[:, 0].max()
miny = pts[:, 1].min()
maxy = pts[:, 1].max()

rows = 512
cols = 512
resx=(maxx-minx)/512
resy = (miny-maxy)/512

def rasterize():
    # Setup working spatial reference
    sr = osr.SpatialReference()
    sr.ImportFromEPSG(4326)
    sr_wkt = sr.ExportToWkt()

    # Create a memory raster to rasterize into.

    target_ds = gdal.GetDriverByName('MEM').Create('', 512, 512, 1,gdal.GDT_Byte)    
    target_ds.SetGeoTransform((minx, resx, 0, maxy, 0, resy))
    target_ds.SetProjection(sr_wkt)
    
    # Create a memory layer to rasterize from.
    rast_ogr_ds = ogr.GetDriverByName('Memory').CreateDataSource('wrk')
    rast_mem_lyr = rast_ogr_ds.CreateLayer('poly', srs=sr)
    
     # Setup Schema
    idField = ogr.FieldDefn("class_id", ogr.OFTInteger)
    rast_mem_lyr.CreateField(idField)
    
    # Add polygons and linestrings.
    i=0
    for g in geojson_list:
        feat = ogr.Feature(rast_mem_lyr.GetLayerDefn())
        geom = ogr.CreateGeometryFromJson(json.dumps(g))
        feat.SetGeometryDirectly(geom)
        feat.SetField('class_id', class_id_values[i])
        rast_mem_lyr.CreateFeature(feat)
        i=i+1
        
    # Run the algorithm.
    err = gdal.RasterizeLayer(target_ds,[1], rast_mem_lyr,
                               options=["ATTRIBUTE=class_id"])

    # Check results.
    # expected = 6452
    # checksum = target_ds.GetRasterBand(2).Checksum()
    # if checksum != expected:
    #     print(checksum)
    #     gdal.GetDriverByName('GTiff').CreateCopy('tmp/rasterize_1.tif', target_ds)
    #     pytest.fail('Did not get expected image checksum')
    gdal.GetDriverByName('GTiff').CreateCopy('E:/tmp/rasterize_3.tif', target_ds)
    assert err == 0, 'got non-zero result code from RasterizeLayer'
    return target_ds


if __name__ == '__main__':
    rasterize()